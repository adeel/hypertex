#!/usr/bin/env python2

import os, os.path
import shutil
import codecs
from optparse import OptionParser
import hypertex

if __name__ == "__main__":
  op = OptionParser()

  op.add_option("-i", "--input", dest="infile",
    help="input file")
  op.add_option("-o", "--output", dest="outfile",
    help="output file")
  op.add_option("-f", "--format", dest="format",
    help="output format (tex or html)")
  op.add_option("--imgdir", dest="img_dir",
    help="for html output, a path to a dir where images will be saved")
  op.add_option("--imgurl", dest="img_base_url",
    help="for html output, the base url to prepend to image paths")

  (options, args) = op.parse_args()

  if not options.infile or not os.path.isfile(options.infile):
    op.error("Please enter a valid input file.")
  if not (options.outfile or options.format):
    op.error("Please enter either an output file or an output format.")

  format = options.format
  if not format:
    format = os.path.splitext(options.outfile)[1].strip(".")
  if format not in ["tex", "html"]:
    op.error("Please choose a valid output format (tex or html).")

  outfile = options.outfile
  if not outfile:
    outfile = os.path.splitext(options.infile)[0] + "." + format

  try:
    input = codecs.open(options.infile, encoding="utf8", mode="r").read()
  except IOError:
    op.error("Unable to open the file: %s" % options.infile)

  img_dir = None
  if options.img_dir:
    img_dir = os.path.abspath(options.img_dir)

  cwd = os.getcwd()
  # this is so that opening other src files will work correctly...
  os.chdir(os.path.dirname(options.infile))

  if format == "html":
    output = hypertex.render_html(input,
      {"img_dir": img_dir, "img_base_url": options.img_base_url})
  elif format == "tex":
    output = hypertex.render_tex(input)

  os.chdir(cwd)
  codecs.open(outfile, encoding="utf8", mode="w").write(output)
